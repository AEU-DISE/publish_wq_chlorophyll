---
title: "Clean Phytoplankton Data"
author: "Jeanette Clark"
date: '2022-05-05'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(readxl)
library(readr)
library(janitor)
library(summarytools)
library(dplyr)
library(knitr)
library(stringr)

st_options(use.x11 = FALSE)
```


 

```{r}
phy <- read_excel("data_raw/phyto_data_raw.xlsx", guess_max = 12359, sheet = 2, na = c("", "n/a", "NA")) %>% 
    clean_names() %>% 
    mutate(organisims_per_ml = factor * unit_abundance) %>% 
    mutate(sample_time = as.character(sample_time)) %>% 
    mutate(sample_time = str_extract(sample_time, "[0-9]{2}:[0-9]{2}:[0-9]{2}$")) %>% 
    mutate(colony_filament_individual_group_code = tolower(colony_filament_individual_group_code)) %>% 
    mutate(colony_filament_individual_group_code = ifelse(colony_filament_individual_group_code == "7.4", NA, colony_filament_individual_group_code)) %>% 
    mutate(colony_filament_individual_group_code = ifelse(colony_filament_individual_group_code == "c3", "c", colony_filament_individual_group_code)) %>% 
    rename(station_code_original = station_code) %>% 
    mutate(station_code = str_extract(station_code_original, "^[A-Z0-9]+")) %>% 
    mutate(sample_time = ifelse(is.na(sample_time), "00:00:00", sample_time)) %>% 
    mutate(datetime = paste(as.character(sample_date), sample_time)) %>% 
    mutate(datetime = as.POSIXct(datetime, tz = "UTC"))
```



```{r, results = "asis"}
st_options(bootstrap.css = FALSE, 
           dfSummary.silent = TRUE)
st_css()

print(dfSummary(phy,
          valid.col = FALSE,  
          plain.ascii = FALSE, 
          graph.magnif = 0.75,
          style = "grid"), method = "render")
```

try and join the wq data (like the temp and salinity and all that) using datetime/station to the phytoplankton such that you can bring over the PhysicalDataID (which is the ID in wq table that will connect to all the other tables later) and create a file of ones that don't match

```{r}
station_main <- read_csv("data_raw/YBFMP_Stations_Coordinates_Info_20200716.csv", show_col_types = F) %>% 
    clean_names() %>% 
    rename(station_code = station_name) %>% 
    select(station_code, station_number, latitude, longitude)


phy_stations <- phy %>%
    left_join(station_main) %>% # we don't really actually need this
    distinct(sample_date, station_code, station_number, latitude, longitude, datetime)

```

```{r}
kable(anti_join(distinct(phy, station_code), station_main))
```



```{r}
wq_ids <- read_csv("data_clean/clean_WQ_phys_20220210.csv", show_col_types = F) %>% 
    clean_names() %>% 
    mutate(datetime = as.POSIXct(datetime, tz = "")) %>% 
    distinct(physical_data_id, station_code, station_number, datetime) %>% 
    mutate(sample_date = as.Date(datetime))

# get combinations of datatime, station code, and physical data id that exist in phy and wq datasets
phy_m <- inner_join(phy_stations, wq_ids, by = c("station_code", "station_number", "datetime")) %>% 
    distinct(datetime, station_code, physical_data_id)
# join those back onto the main phytoplankton dataset
phy_joined <- left_join(phy, phy_m)
```

Reorder the columns for the final dataset

```{r}
id_cols <- c("sample_date",
             "sample_time",
             "datetime",
             "station_code",
             "station_code_original",
             "physical_data_id",
             "method_code",
             "depth_m")

sample_info_cols <- c("volume_received_m_l",
                      "volume_analyzed_m_l",
                      "organisims_per_ml",
                      "percent_of_sample_counted",
                      "field_of_view_mm2",
                      "slide_chamber_area_mm2",
                      "area_counted",
                      "dimension",
                      "number_of_fields_counted",
                      "factor",
                      "bsa_tin",
                      "bsa_number",
                      "taxonomist",
                      "comments")

measurement_colnames <- c("organisims_per_ml",
                          "unit_abundance",
                          "number_of_cells_per_unit",
                          "taxon",
                          "genus",
                          "species",
                          "synonym",
                          "diatom_soft_body",
                          "colony_filament_individual_group_code",
                          "shape")

colnames_init <- c(id_cols, sample_info_cols, measurement_colnames)
colnames_remain <- colnames(phy_joined)[which(!(colnames(phy_joined) %in% colnames_init))]

phy_final <- phy_joined %>% 
    select(all_of(colnames_init), all_of(colnames_remain))

```

